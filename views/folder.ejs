<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/header.css">
    <link rel="stylesheet" href="/folder.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= folder.name %> ¬∑ MyDrive</title>
  </head>
  <body>
    <%- include("partials/header.ejs") %>

    <div class="mainContainer">
      <section class="folder-view">

        <!-- Top bar -->
        <div class="folder-top">
          <div class="folder-title">
            <a href="/" class="back-link">‚Üê Back to home</a>
            <h1>üìÅ <%= folder.name %></h1>
          </div>

          <div class="folder-actions">
            <form method="POST" action="/folders/<%= folder.id %>/rename" class="rename-form">
              <input type="text" name="name" value="<%= folder.name %>" required />
              <button class="btn btn-outline" type="submit">Rename</button>
            </form>

            <form
              method="POST"
              action="/folders/<%= folder.id %>/delete"
              onsubmit="return confirm('Are you sure? Deleting this folder will delete all files inside it.')"
            >
              <button class="btn btn-danger" type="submit">Delete folder</button>
            </form>
          </div>
        </div>

        <!-- Files -->
        <% if (files.length > 0) { %>
          <div class="files-grid">
            <% files.forEach(file => { %>
              <a
                href="/folders/<%= folder.id %>/files/<%= file.id %>"
                class="file-card"
              >
                <div class="file-icon">üìÑ</div>
                <div class="file-name"><%= file.name %></div>
                <div class="file-meta">
                  <span><%= (file.size / 1024 / 1024).toFixed(2) %> MB</span>
                  <span><%= file.createdAt.toLocaleDateString() %></span>
                </div>
              </a>
            <% }) %>
          </div>
        <% } else { %>
          <p class="empty-folder">This folder is empty.</p>
        <% } %>

        <!-- Upload form -->
        <form
          class="upload-form"
          method="POST"
          action="/folders/<%= folder.id %>/upload"
          enctype="multipart/form-data"
        >
          <% if (error) { %>
            <div class="error"><%= error.msg %></div>
          <% } %>

          <div id="dropzone" class="file-dropzone">
            <input id="file-upload" type="file" name="file" required />

            <div class="file-dropzone-content">
              <span class="file-icon">üì§</span>
              <p id="dropzone-text">Click or drag a file here to upload</p>
              <small class="supported-files">
                Supported: PDF, DOCX, XLSX, XLS, JPEG, PNG, GIF, WEBP, TXT, CSV, ZIP
                (max 50MB)
              </small>
              <small id="selected-file">No file selected</small>
            </div>
          </div>

          <button class="btn btn-primary" type="submit">Upload</button>
        </form>

      </section>
    </div>

    <!-- Drag & drop logic -->
    <script>
      const MAX_SIZE = 50 * 1024 * 1024;

      const dropzone = document.getElementById("dropzone");
      const fileInput = document.getElementById("file-upload");
      const selectedFile = document.getElementById("selected-file");
      const dropzoneText = document.getElementById("dropzone-text");

      function resetUI() {
        fileInput.value = "";
        selectedFile.textContent = "No file selected";
        dropzoneText.textContent = "Click or drag a file here to upload";
      }

      function handleFile(file) {
        if (file.size > MAX_SIZE) {
          alert("File too large. Max 50MB.");
          resetUI();
          return false;
        }

        selectedFile.textContent = file.name;
        dropzoneText.textContent = "File ready to upload";
        return true;
      }

      // Click opens file picker
      dropzone.addEventListener("click", () => fileInput.click());

      // File picker
      fileInput.addEventListener("change", () => {
        if (fileInput.files.length > 0) {
          handleFile(fileInput.files[0]);
        }
      });

      // Drag over
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("dragover");
      });

      // Drag leave
      dropzone.addEventListener("dragleave", () => {
        dropzone.classList.remove("dragover");
      });

      // Drop
      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("dragover");

        if (e.dataTransfer.files.length > 0) {
          const file = e.dataTransfer.files[0];
          if (handleFile(file)) {
            fileInput.files = e.dataTransfer.files;
          }
        }
      });
    </script>

  </body>
</html>
